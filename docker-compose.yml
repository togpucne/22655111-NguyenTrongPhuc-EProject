version: "3.8"

services:
  # üß† AUTH SERVICE
  auth:
    build: ./auth
    ports:
      - "3001:3001"
    env_file:
      - ./auth/.env
    depends_on:
      - mongo-auth
    networks:
      - ecommerce

  # üê∞ RABBITMQ (Message Broker)
  rabbitmq:
    image: rabbitmq:3.8-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672"     # AMQP
      - "15672:15672"   # Dashboard
    volumes:
      - ~/.docker-conf/rabbitmq/data/:/var/lib/rabbitmq/
      - ~/.docker-conf/rabbitmq/log/:/var/log/rabbitmq
    networks:
      - ecommerce

  # üßæ ORDER SERVICE
  order:
    build: ./order
    ports:
      - "3004:3004"
    env_file:
      - ./order/.env
    depends_on:
      - rabbitmq
      - mongo-order
    networks:
      - ecommerce

  # üì¶ PRODUCT SERVICE
  product:
    build: ./product
    ports:
      - "3002:3002"
    depends_on:
      - rabbitmq
      - mongo-product
    env_file:
      - ./product/.env
    networks:
      - ecommerce


  # üåê API GATEWAY
  api-gateway:
    build: ./api-gateway
    ports:
      - "3003:3003"
    env_file:
      - ./api-gateway/.env
    depends_on:
      - auth
      - product
      - order
    networks:
      - ecommerce

  # üçÉ MONGODB CHO M·ªñI SERVICE
  mongo-auth:
    image: mongo:6
    container_name: mongo-auth
    ports:
      - "27017:27017"
    volumes:
      - mongo-auth-data:/data/db
    networks:
      - ecommerce

  mongo-product:
    image: mongo:6
    container_name: mongo-product
    ports:
      - "27018:27017"
    volumes:
      - mongo-product-data:/data/db
    networks:
      - ecommerce

  mongo-order:
    image: mongo:6
    container_name: mongo-order
    ports:
      - "27019:27017"
    volumes:
      - mongo-order-data:/data/db
    networks:
      - ecommerce

networks:
  ecommerce:

volumes:
  mongo-auth-data:
  mongo-product-data:
  mongo-order-data:
